<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const GEOSERVER_WMS = 'https://YOUR-PUBLIC-HOST/geoserver/uhi_app/wms';
  const LAYER_NAME    = 'uhi_app:lga_with_uhi_veg_final';

  const map = L.map('map').setView([-37.8,144.9],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {attribution:'Â© OpenStreetMap'}).addTo(map);

  const common = { layers:LAYER_NAME, format:'image/png', transparent:true, version:'1.3.0', opacity:0.85 };
  const heat = L.tileLayer.wms(GEOSERVER_WMS, { ...common, styles:'heat_simple' });
  const veg  = L.tileLayer.wms(GEOSERVER_WMS, { ...common, styles:'veg_simple'  });
  const age  = L.tileLayer.wms(GEOSERVER_WMS, { ...common, styles:'age65_counts' });

  heat.addTo(map);

  const overlays = { 'Heat (UHI mean)': heat, 'Vegetation %': veg, 'Age 65+ (count)': age };
  L.control.layers(null, overlays, {collapsed:false}).addTo(map);

  // --- Legend (GetLegendGraphic) ---
  const legendCtl = L.control({position:'bottomleft'});
  legendCtl.onAdd = () => {
    const d = L.DomUtil.create('div'); d.className='legend';
    d.style.cssText='background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.1);';
    d.id = 'legendBox'; return d;
  };
  legendCtl.addTo(map);

  function legendUrl(styleName){
    const p = new URLSearchParams({
      SERVICE:'WMS', REQUEST:'GetLegendGraphic', VERSION:'1.3.0',
      FORMAT:'image/png', LAYER:LAYER_NAME, STYLE:styleName, WIDTH:20, HEIGHT:20
    });
    return `${GEOSERVER_WMS}?${p.toString()}`;
  }
  function setLegend(styleName,label){
    const box = document.getElementById('legendBox');
    box.innerHTML = `<div style="font:14px system-ui;margin-bottom:4px;"><b>${label}</b></div>
                     <img alt="legend" src="${legendUrl(styleName)}">`;
  }
  setLegend('heat_simple','Heat (UHI mean)');

  // Update legend when overlay changes
  map.on('overlayadd', e => {
    if (e.layer===heat) setLegend('heat_simple','Heat (UHI mean)');
    if (e.layer===veg ) setLegend('veg_simple','Vegetation %');
    if (e.layer===age ) setLegend('age65_counts','Age 65+ (count)');
  });

  // --- GetFeatureInfo (JSON with HTML fallback) ---
  function gfiUrl(latlng, layer){
    const pt = map.latLngToContainerPoint(latlng, map.getZoom());
    const size = map.getSize();
    const params = {
      request:'GetFeatureInfo', service:'WMS',
      version:layer.wmsParams.version, format:layer.wmsParams.format,
      transparent:true, query_layers:layer.wmsParams.layers, layers:layer.wmsParams.layers,
      i:Math.trunc(pt.x), j:Math.trunc(pt.y), // 1.3.0
      info_format:'application/json', feature_count:5,
      srs:'EPSG:4326', bbox:map.getBounds().toBBoxString(), width:size.x, height:size.y,
      styles:layer.wmsParams.styles||''
    };
    return GEOSERVER_WMS + L.Util.getParamString(params, GEOSERVER_WMS, true);
  }
  function active(){ if(map.hasLayer(veg)) return veg; if(map.hasLayer(age)) return age; return heat; }

  map.on('click', async e => {
    const layer = active();
    let url = gfiUrl(e.latlng, layer);
    try {
      let res = await fetch(url);
      if (res.headers.get('content-type')?.includes('application/json')){
        const json = await res.json();
        const f = json.features?.[0];
        if(!f){ L.popup().setLatLng(e.latlng).setContent('No feature here.').openOn(map); return; }
        const p = f.properties||{};
        const html = `<div style="font:14px system-ui">
          <b>${p.lga_name??'-'}</b><br>
          UHI mean: ${p.uhi18_m_mean?.toFixed?.(2) ?? p.uhi18_m_mean ?? '-'}<br>
          Vegetation %: ${p.peranyveg_mean?.toFixed?.(2) ?? p.peranyveg_mean ?? '-'}<br>
          65+ (count): ${p.persons_65plus ?? '-'}
        </div>`;
        L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
      } else {
        // Fallback to HTML
        url = url.replace('application/json','text/html');
        const html = await (await fetch(url)).text();
        L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
      }
    } catch (err) {
      console.error(err);
      L.popup().setLatLng(e.latlng).setContent('GetFeatureInfo error').openOn(map);
    }
  });
</script>
