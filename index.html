<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Melbourne UHI App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0}
    .info-popup table{border-collapse:collapse;font:14px/1.2 system-ui, sans-serif}
    .info-popup td{padding:2px 6px;border-bottom:1px solid #eee}
    .info-popup td:first-child{font-weight:600;color:#555}
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // --- CONFIG ---
  const GEOSERVER_WMS = 'http://localhost:8080/geoserver/uhi_app/wms';
  const LAYER_NAME    = 'uhi_app:lga_with_uhi_veg_final';

  // Base map
  const map = L.map('map').setView([-37.8, 144.9], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution: '© OpenStreetMap contributors' }).addTo(map);

  // Three WMS styles as toggleable overlays
  const baseWmsOpts = {
    layers: LAYER_NAME,
    format: 'image/png',
    transparent: true,
    version: '1.3.0' // important for I/J vs X/Y
  };
  const heat = L.tileLayer.wms(GEOSERVER_WMS, { ...baseWmsOpts, styles: 'heat_simple' }).addTo(map);
  const veg  = L.tileLayer.wms(GEOSERVER_WMS, { ...baseWmsOpts, styles: 'veg_simple'  });
  const age  = L.tileLayer.wms(GEOSERVER_WMS, { ...baseWmsOpts, styles: 'age65_counts' });

  L.control.layers(null, {
    'Heat (UHI mean)': heat,
    'Vegetation %'   : veg,
    'Age 65+ (count)': age
  }, { collapsed:false }).addTo(map);

  // --- GetFeatureInfo helper ---
  function getFeatureInfoUrl(latlng, layer, map) {
    // Build a WMS GetFeatureInfo request for the clicked pixel
    const point = map.latLngToContainerPoint(latlng, map.getZoom());
    const size  = map.getSize();

    // Common params
    const params = {
      request: 'GetFeatureInfo',
      service: 'WMS',
      srs: 'EPSG:4326',
      styles: layer.wmsParams.styles || '',
      transparent: true,
      version: layer.wmsParams.version,
      format: layer.wmsParams.format,
      bbox: map.getBounds().toBBoxString(),        
      height: size.y,
      width: size.x,
      layers: layer.wmsParams.layers,
      query_layers: layer.wmsParams.layers,
      info_format: 'application/json',             
      feature_count: 5
    };

    // WMS 1.3.0 uses I/J; 1.1.1 uses X/Y
    if (params.version === '1.3.0') {
      params.i = Math.trunc(point.x);
      params.j = Math.trunc(point.y);
    } else {
      params.x = Math.trunc(point.x);
      params.y = Math.trunc(point.y);
    }

    const url = GEOSERVER_WMS + L.Util.getParamString(params, GEOSERVER_WMS, true);
    return url;
  }

  function formatPopup(props) {
    // fields 
    const name   = props.lga_name;
    const heat   = props.uhi18_m_mean;
    const veg    = props.peranyveg_mean;
    const age65  = props.persons_65plus;

    return `
      <div class="info-popup">
        <table>
          <tr><td>LGA</td><td>${name ?? '-'}</td></tr>
          <tr><td>UHI mean</td><td>${heat != null ? Number(heat).toFixed(2) : '-'}</td></tr>
          <tr><td>Vegetation %</td><td>${veg != null ? Number(veg).toFixed(2) : '-'}</td></tr>
          <tr><td>65+ (count)</td><td>${age65 ?? '-'}</td></tr>
        </table>
      </div>`;
  }

 
  function activeOverlay() {
    // overlay among heat, veg, age 
    if (map.hasLayer(veg))  return veg;
    if (map.hasLayer(age))  return age;
    return heat;
  }

  map.on('click', async (e) => {
    const layer = activeOverlay();
    const url = getFeatureInfoUrl(e.latlng, layer, map);

    try {
      const res = await fetch(url);
      

      const json = await res.json();
      const first = json.features && json.features[0];
      if (!first) {
        L.popup().setLatLng(e.latlng).setContent('No feature here.').openOn(map);
        return;
      }
      const html = formatPopup(first.properties || {});
      L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
    } catch (err) {
      L.popup().setLatLng(e.latlng).setContent('GetFeatureInfo error').openOn(map);
      console.error(err);
    }
  });
</script>

<!-- License / attribution -->
<p style="position:absolute;left:8px;bottom:6px;background:#fff7;padding:4px 8px;border-radius:4px;">
  <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="license noopener">
    <img src="https://licensebuttons.net/l/by/4.0/88x31.png" alt="CC BY 4.0" style="vertical-align:middle">
  </a>
  <span style="margin-left:8px;">This Cloud-based Open-source GIS Application is developed by <a href="#" target="_blank" rel="noopener">Your Name</a> — CC BY 4.0</span>
</p>
</body>
</html>
