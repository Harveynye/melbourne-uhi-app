<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Melbourne UHI App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0}
    .legend, .metric {background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.1);font:14px/1.2 system-ui,sans-serif}
    .legend i{display:inline-block;width:12px;height:12px;margin-right:6px;vertical-align:middle}
    .metric {position:absolute;right:10px;top:10px;z-index:1000}
    .legend {position:absolute;left:10px;bottom:10px;z-index:1000}
    .info-popup table{border-collapse:collapse}
    .info-popup td{padding:2px 6px;border-bottom:1px solid #eee}
    .info-popup td:first-child{font-weight:600;color:#555}
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // --- Map ---
  const map = L.map('map').setView([-37.8, 144.9], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution: '© OpenStreetMap contributors' }).addTo(map);

  // --- Metric selector (heat / veg / age) ---
  const metrics = {
    heat: { field:'uhi18_m_mean', title:'Heat (UHI mean)',
      breaks:[7.5,8.2,8.9,9.6], colors:['#ffffcc','#ffe082','#fdae61','#f46d43','#d73027'],
      fmt:v=>v==null?'-':Number(v).toFixed(2)
    },
    veg:  { field:'peranyveg_mean', title:'Vegetation %',
      breaks:[10,20,30,40], colors:['#f7fcf5','#c7e9c0','#74c476','#238b45','#00441b'],
      fmt:v=>v==null?'-':Number(v).toFixed(2)
    },
    age:  { field:'persons_65plus', title:'Age 65+ (count)',
      breaks:[5000,10000,15000,20000], colors:['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'],
      fmt:v=>v==null?'-':v
    }
  };
  let current = 'heat';

  // UI: metric dropdown
  const metricCtl = L.control({position:'topright'});
  metricCtl.onAdd = () => {
    const d = L.DomUtil.create('div','metric');
    d.innerHTML = `
      <label><strong>Metric</strong></label><br>
      <select id="metricSel">
        <option value="heat">Heat (UHI mean)</option>
        <option value="veg">Vegetation %</option>
        <option value="age">Age 65+ (count)</option>
      </select>`;
    return d;
  };
  metricCtl.addTo(map);
  document.addEventListener('change', e=>{
    if(e.target && e.target.id==='metricSel'){ current = e.target.value; restyle(); updateLegend(); }
  });

  // Legend
  const legend = L.control({position:'bottomleft'});
  legend.onAdd = () => {
    const d = L.DomUtil.create('div','legend');
    d.id = 'legend';
    return d;
  };
  legend.addTo(map);

  // Color helper
  function colorFor(v, brks, colors){
    if(v==null) return '#cccccc';
    for(let i=0;i<brks.length;i++){ if(v<=brks[i]) return colors[i]; }
    return colors[colors.length-1];
  }

  // Popup formatter
  function popupHtml(p){
    return `
      <div class="info-popup">
        <table>
          <tr><td>LGA</td><td>${p.lga_name ?? '-'}</td></tr>
          <tr><td>UHI mean</td><td>${metrics.heat.fmt(p.uhi18_m_mean)}</td></tr>
          <tr><td>Vegetation %</td><td>${metrics.veg.fmt(p.peranyveg_mean)}</td></tr>
          <tr><td>65+ (count)</td><td>${metrics.age.fmt(p.persons_65plus)}</td></tr>
        </table>
      </div>`;
  }

  let geoLayer = null, geojson = null;

  // Load GeoJSON from your repo (adjust path if you put it in /data/)
  fetch('lga_uhi_app.geojson')
    .then(r => r.json())
    .then(data => {
      geojson = data;
      addLayer();
      updateLegend();
      try { map.fitBounds(L.geoJSON(geojson).getBounds()); } catch(_) {}
    })
    .catch(err => {
      console.error('Failed to load GeoJSON:', err);
      alert('Could not load GeoJSON. Make sure lga_uhi_app.geojson is in the repo root.');
    });

  function addLayer(){
    if(geoLayer) map.removeLayer(geoLayer);
    geoLayer = L.geoJSON(geojson, {
      style: feat => {
        const m = metrics[current];
        const v = feat.properties[m.field];
        return { color:'#666', weight:0.6, fillOpacity:0.85,
          fillColor: colorFor(v, m.breaks, m.colors) };
      },
      onEachFeature: (feat, layer) => {
        layer.on('click', () => layer.bindPopup(popupHtml(feat.properties)).openPopup());
      }
    }).addTo(map);
  }

  function restyle(){
    if(!geoLayer) return;
    geoLayer.setStyle(feat => {
      const m = metrics[current];
      const v = feat.properties[m.field];
      return { fillColor: colorFor(v, m.breaks, m.colors) };
    });
  }

  function updateLegend(){
    const m = metrics[current];
    const d = document.getElementById('legend');
    const labels = [];
    let prev = -Infinity;
    for(let i=0;i<m.breaks.length;i++){
      const to = m.breaks[i];
      labels.push(`<div><i style="background:${m.colors[i]}"></i>${prev===-Infinity?'≤ ':''}${to}</div>`);
      prev = to;
    }
    labels.push(`<div><i style="background:${m.colors[m.colors.length-1]}"></i>&gt; ${m.breaks[m.breaks.length-1]}</div>`);
    d.innerHTML = `<strong>${m.title}</strong><br>${labels.join('')}`;
  }
</script>

<!-- Attribution & license -->
<p style="position:absolute;left:8px;top:10px;background:#fff7;padding:4px 8px;border-radius:4px;">
  <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="license noopener">
    <img src="https://licensebuttons.net/l/by/4.0/88x31.png" alt="CC BY 4.0" style="vertical-align:middle">
  </a>
  <span style="margin-left:8px;">This Cloud-based Open-source GIS Application is developed by <a href="#" target="_blank" rel="noopener">Your Name</a> — CC BY 4.0</span>
</p>
</body>
</html>
